    <!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <!-- Meta tag untuk mencegah zoom dan geser di ponsel -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Dashboard Promo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #4e73df; --success-color: #1cc88a; --info-color: #36b9cc; --warning-color: #f6c23e; --danger-color: #e74a3b; --secondary-color: #858796; --light-color: #f8f9fc; --dark-color: #5a5c69;
        }
        * { box-sizing: border-box; }
        
        /* PERUBAHAN UTAMA: Membatasi tampilan ke ukuran ponsel saja */
        body {
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 0;
            color: var(--dark-color);
            overflow-x: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        /* Container utama dengan ukuran ponsel */
        .phone-container {
            width: 350px;
            height: 100vh;
            max-height: 800px;
            background-color: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }
        
        /* PERUBAHAN: Sembunyikan notifikasi desktop secara permanen */
        .desktop-notification {
            display: none !important;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            color: white;
            z-index: 9999;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        
        .dashboard-container { 
            display: flex; 
            min-height: 100vh; 
            height: 100%;
            overflow: hidden;
        }
        
        .sidebar { 
            width: 250px; 
            background: linear-gradient(180deg, #4e73df 10%, #224abe 100%); 
            color: white; 
            padding-top: 1.5rem; 
            position: fixed; 
            height: 100vh; 
            left: 0; 
            top: 0; 
            z-index: 1000; 
            transition: transform 0.3s ease; 
        }
        
        .sidebar.collapsed { transform: translateX(-100%); }
        .sidebar .sidebar-brand { text-align: center; font-weight: 700; font-size: 1.2rem; padding: 0 1rem 1.5rem 1rem; border-bottom: 1px solid rgba(255,255,255,0.2); margin-bottom: 20px; }
        .sidebar .nav-link { display: flex; align-items: center; padding: 1rem 1.5rem; color: rgba(255,255,255,0.8); text-decoration: none; transition: all 0.3s; cursor: pointer; border: none; background: none; width: 100%; text-align: left; }
        .sidebar .nav-link:hover, .sidebar .nav-link.active { color: white; background-color: rgba(255,255,255,0.1); }
        .sidebar .nav-link i { margin-right: 0.75rem; width: 20px; text-align: center; }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; margin-left: 0; transition: margin-left 0.3s ease; height: 100%; overflow: hidden; }
        .main-content.expanded { margin-left: 0; }
        .topbar { height: 60px; background-color: white; box-shadow: 0 0.15rem 1.75rem 0 rgba(58,59,69,0.15); display: flex; align-items: center; justify-content: space-between; padding: 0 1rem; position: sticky; top: 0; z-index: 100; }
        .topbar .menu-toggle { display: block; background: none; border: none; font-size: 1.5rem; color: var(--dark-color); cursor: pointer; padding: 0.5rem; }
        .topbar .user-name { font-weight: 600; color: var(--dark-color); font-size: 0.9rem; }
        .content { flex-grow: 1; padding: 0.5rem; padding-bottom: 70px; overflow-y: auto; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; margin-bottom: 1rem; }
        .stat-card { background-color: white; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 0.15rem 1.75rem 0 rgba(58,59,69,0.1); border-left: 0.5rem solid var(--primary-color); display: flex; justify-content: space-between; align-items: center; }
        .stat-card.success { border-left-color: var(--success-color); }
        .stat-card.info { border-left-color: var(--info-color); }
        .stat-card.warning { border-left-color: var(--warning-color); }
        .stat-card .stat-info .stat-title { font-size: 0.7rem; color: var(--secondary-color); text-transform: uppercase; margin-bottom: 0.25rem; }
        .stat-card .stat-info .stat-value { font-size: 1.2rem; font-weight: 700; color: var(--dark-color); }
        .stat-card .stat-icon i { font-size: 1.5rem; opacity: 0.3; }
        .stat-card.primary .stat-icon i { color: var(--primary-color); }
        .stat-card.success .stat-icon i { color: var(--success-color); }
        .stat-card.info .stat-icon i { color: var(--info-color); }
        .stat-card.warning .stat-icon i { color: var(--warning-color); }
        .data-card { background-color: white; border-radius: 0.5rem; box-shadow: 0 0.15rem 1.75rem 0 rgba(58,59,69,0.1); margin-bottom: 1rem; }
        .data-card .card-header { padding: 1rem; border-bottom: 1px solid #e3e6f0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
        .data-card .card-header h3 { margin: 0; font-weight: 700; color: var(--dark-color); font-size: 1rem; }
        .data-card .card-body { padding: 1rem; }
        .table { width: 100%; margin-bottom: 0; font-size: 0.85rem; }
        .table thead th { border-top: none; border-bottom: 2px solid #e3e6f0; font-weight: 700; font-size: 0.75rem; text-transform: uppercase; color: var(--secondary-color); padding: 0.5rem; }
        .table tbody tr:hover { background-color: rgba(0,0,0,.05); }
        .table td, .table th { padding: 0.5rem; vertical-align: middle; }
        .btn-action { padding: 0.25rem 0.4rem; border: none; border-radius: 0.25rem; color: white; cursor: pointer; margin: 0 0.1rem; font-size: 0.7rem; transition: all 0.2s; }
        .btn-edit { background-color: var(--info-color); }
        .btn-delete { background-color: var(--danger-color); }
        .btn-promo { background-color: #17a2b8; font-weight: 600; }
        .btn-promo:hover { background-color: #138496; transform: translateY(-1px); }
        .btn-action:hover { opacity: 0.8; }
        .btn-add { background-color: var(--success-color); color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 0.25rem; cursor: pointer; font-size: 0.8rem; transition: all 0.2s; white-space: nowrap; }
        .btn-add:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-add i { margin-right: 0.3rem; }
        .btn-primary { background-color: var(--primary-color); }
        .btn-warning { background-color: var(--warning-color); color: var(--dark-color); }
        .btn-info { background-color: var(--info-color); }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); animation: fadeIn 0.3s; }
        .modal.show { display: flex; justify-content: center; align-items: center; padding: 1rem; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 0.5rem; width: 95%; max-width: 350px; animation: slideIn 0.3s; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .modal-header h3 { margin: 0; font-size: 1.1rem; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--secondary-color); }
        .form-group { margin-bottom: 0.8rem; }
        .form-group label { display: block; margin-bottom: 0.3rem; font-weight: 600; font-size: 0.9rem; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 0.6rem; border: 1px solid #d1d3e2; border-radius: 0.35rem; font-size: 0.9rem; }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .btn-save { width: 100%; padding: 0.6rem; background-color: var(--primary-color); color: white; border: none; border-radius: 0.35rem; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; }
        .btn-save:hover { background-color: #2e59d9; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 10px 15px; background-color: var(--success-color); color: white; border-radius: 5px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transform: translateX(400px); transition: transform 0.3s ease-in-out; z-index: 3000; max-width: 250px; font-size: 0.85rem; }
        .notification.show { transform: translateX(0); }
        .image-preview { width: 100%; max-height: 150px; object-fit: contain; border: 1px solid #d1d3e2; border-radius: 0.35rem; margin-top: 0.5rem; }
        .tab-container { margin-bottom: 1rem; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .checkbox-group { display: flex; flex-wrap: wrap; max-height: 150px; overflow-y: auto; border: 1px solid #d1d3e2; border-radius: 0.35rem; padding: 0.5rem; }
        .checkbox-item { display: flex; align-items: center; margin-right: 1rem; margin-bottom: 0.5rem; width: 100%; }
        .checkbox-item input { margin-right: 0.5rem; width: auto; }
        .checkbox-item label { margin-bottom: 0; font-weight: normal; font-size: 0.85rem; }
        .selected-count { margin-top: 0.5rem; font-size: 0.8rem; color: var(--secondary-color); }
        .promo-type-selector { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .promo-type-option { flex: 1; padding: 0.8rem; border: 2px solid #d1d3e2; border-radius: 0.35rem; text-align: center; cursor: pointer; transition: all 0.3s; }
        .promo-type-option.selected { border-color: var(--primary-color); background-color: #f8f9fc; }
        .promo-type-option i { font-size: 1.5rem; margin-bottom: 0.3rem; color: var(--primary-color); }
        .promo-type-option h4 { margin: 0 0 0.2rem 0; font-size: 0.9rem; }
        .promo-type-option p { margin: 0; font-size: 0.75rem; color: var(--secondary-color); }
        .member-selection { display: none; }
        .member-selection.show { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Bottom Navigation Bar */
        .bottombar {
            height: 60px;
            background-color: white;
            box-shadow: 0 -0.15rem 1.75rem 0 rgba(58,59,69,0.15);
            display: flex;
            justify-content: space-around;
            align-items: center;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }
        .bottombar .nav-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--secondary-color);
            text-decoration: none;
            font-size: 0.7rem;
            transition: color 0.3s;
            padding: 0.5rem;
        }
        .bottombar .nav-link.active, .bottombar .nav-link:hover {
            color: var(--primary-color);
        }
        .bottombar .nav-link i {
            font-size: 1.2rem;
            margin-bottom: 0.25rem;
        }
        
        /* Mobile Responsive Styles - Semua style di sini untuk ukuran ponsel */
        .sidebar { transform: translateX(-100%); }
        .sidebar.active { transform: translateX(0); }
        .main-content { margin-left: 0; }
        .content { padding: 0.5rem; padding-bottom: 70px; }
        .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
        .data-card .card-header { flex-direction: column; align-items: flex-start; }
        .data-card .card-header h3 { font-size: 1rem; }
        .btn-add { font-size: 0.75rem; padding: 0.4rem 0.6rem; }
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .table { min-width: 500px; }
        .modal-content { width: 95%; padding: 1rem; }
        .notification { right: 10px; left: 10px; transform: translateY(-100px); }
        .notification.show { transform: translateY(0); }
        .stat-card { padding: 0.8rem; }
        .stat-card .stat-info .stat-value { font-size: 1.1rem; }
        .data-card .card-body { padding: 0.8rem; }
        .promo-type-selector { flex-direction: column; }
        /* Sembunyikan sidebar nav link di mobile, gunakan bottombar */
        .sidebar { display: none; }
        .main-content { margin-left: 0 !important; } /* Pastikan margin selalu 0 di mobile */
    </style>
</head>
<body>
<!-- Notifikasi untuk layar lebih besar - TETAP ADA TAPI DISEMBUNYYKAN -->
<div class="desktop-notification" id="desktopNotification">
    <div>
        <h2><i class="fas fa-mobile-alt"></i> Tampilan Ponsel Saja</h2>
        <p>Halaman ini dirancang khusus untuk tampilan ponsel (350px). Silakan perkecil jendela browser Anda atau gunakan mode tampilan ponsel.</p>
        <button class="btn-add" onclick="continueAnyway()">Lanjutkan Saja</button>
    </div>
</div>

<!-- Container utama dengan ukuran ponsel -->
<div class="phone-container">
    <div class="dashboard-container">
        <aside class="sidebar" id="sidebar"> 
            <li class="sidebar-brand"> Promo Panel </li> 
            <li><a class="nav-link active" data-tab="events"><i class="fas fa-calendar-alt"></i> <span>Kopdar</span></a></li> 
            <li><a class="nav-link" data-tab="promos"><i class="fas fa-tags"></i> <span>Promo</span></a></li> 
            <li><a class="nav-link" data-tab="memberPromos"><i class="fas fa-gift"></i> <span>Promo Anggota</span></a></li>
        </aside>
        <main class="main-content" id="mainContent">
            <div class="topbar"> 
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <span class="user-name">Admin</span> 
            </div>
            <div class="content">
                <div class="stats-grid">
                    <div class="stat-card primary">
                        <div class="stat-info">
                            <div class="stat-title">TOTAL KOPDAR</div>
                            <div class="stat-value" id="totalEvents">0</div>
                        </div>
                        <div class="stat-icon primary"><i class="fas fa-calendar-alt"></i></div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-info">
                            <div class="stat-title">TOTAL PROMO</div>
                            <div class="stat-value" id="totalPromos">0</div>
                        </div>
                        <div class="stat-icon success"><i class="fas fa-tags"></i></div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-info">
                            <div class="stat-title">PROMO AKTIF</div>
                            <div class="stat-value" id="activePromos">0</div>
                        </div>
                        <div class="stat-icon info"><i class="fas fa-check-circle"></i></div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-info">
                            <div class="stat-title">PROMO TERKIRIM</div>
                            <div class="stat-value" id="sentPromos">0</div>
                        </div>
                        <div class="stat-icon warning"><i class="fas fa-paper-plane"></i></div>
                    </div>
                </div>
                
                <!-- Tab Container -->
                <div class="tab-container">
                    <!-- Tab Events -->
                    <div id="events-tab" class="tab-content active">
                        <div class="data-card">
                            <div class="card-header">
                                <h3>Data Kopdar</h3>
                                <button class="btn-add" onclick="openEventModal()"><i class="fas fa-plus"></i> Tambah</button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Gambar</th>
                                                <th>Nama</th>
                                                <th>Tanggal</th>
                                                <th>Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="eventTableBody">
                                            <tr><td colspan="4" style="text-align:center;">Memuat data...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab Promos -->
                    <div id="promos-tab" class="tab-content">
                        <div class="data-card">
                            <div class="card-header">
                                <h3>Data Promo</h3>
                                <button class="btn-add" onclick="openPromoModal()"><i class="fas fa-plus"></i> Tambah</button>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Gambar</th>
                                                <th>Judul</th>
                                                <th>Kadaluarsa</th>
                                                <th>Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="promoTableBody">
                                            <tr><td colspan="4" style="text-align:center;">Memuat data...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab Member Promos -->
                    <div id="memberPromos-tab" class="tab-content">
                        <div class="data-card">
                            <div class="card-header">
                                <h3>Promo Anggota</h3>
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <button class="btn-add btn-primary" onclick="openCreatePromoModal()"><i class="fas fa-plus"></i> Buat</button>
                                    <button class="btn-add btn-warning" onclick="openPublicPromoModal()"><i class="fas fa-bullhorn"></i> Publik</button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Gambar</th>
                                                <th>Judul</th>
                                                <th>Dikirim ke</th>
                                                <th>Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody id="memberPromoTableBody">
                                            <tr><td colspan="4" style="text-align:center;">Memuat data...</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Bottom Navigation Bar -->
    <nav class="bottombar">
        <a class="nav-link active" data-tab="events"><i class="fas fa-calendar-alt"></i> <span>Kopdar</span></a>
        <a class="nav-link" data-tab="promos"><i class="fas fa-tags"></i> <span>Promo</span></a>
        <a class="nav-link" data-tab="memberPromos"><i class="fas fa-gift"></i> <span>Promo Anggota</span></a>
    </nav>
</div>

<!-- Event Modal -->
<div id="eventModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="eventModalTitle">Tambah Kopdar</h3>
            <span class="close-btn" onclick="closeEventModal()">&times;</span>
        </div>
        <form id="eventForm">
            <input type="hidden" id="eventId">
            <div class="form-group">
                <label for="eventName">Nama Kopdar</label>
                <input type="text" id="eventName" required>
            </div>
            <div class="form-group">
                <label for="eventDescription">Deskripsi</label>
                <textarea id="eventDescription" required></textarea>
            </div>
            <div class="form-group">
                <label for="eventDate">Tanggal</label>
                <input type="datetime-local" id="eventDate" required>
            </div>
            <div class="form-group">
                <label for="eventStatus">Status</label>
                <select id="eventStatus">
                    <option value="active">Aktif</option>
                    <option value="inactive">Tidak Aktif</option>
                </select>
            </div>
            <div class="form-group">
                <label for="eventImage">Gambar</label>
                <input type="file" id="eventImage" accept="image/*">
                <img id="eventImagePreview" class="image-preview" style="display:none;">
            </div>
            <button type="submit" class="btn-save">Simpan</button>
        </form>
    </div>
</div>

<!-- Promo Modal -->
<div id="promoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="promoModalTitle">Tambah Promo</h3>
            <span class="close-btn" onclick="closePromoModal()">&times;</span>
        </div>
        <form id="promoForm">
            <input type="hidden" id="promoId">
            <div class="form-group">
                <label for="promoTitle">Judul Promo</label>
                <input type="text" id="promoTitle" required>
            </div>
            <div class="form-group">
                <label for="promoDescription">Deskripsi</label>
                <textarea id="promoDescription" required></textarea>
            </div>
            <div class="form-group">
                <label for="promoExpiryDate">Tanggal Kadaluarsa</label>
                <input type="date" id="promoExpiryDate" required>
            </div>
            <div class="form-group">
                <label for="promoStatus">Status</label>
                <select id="promoStatus">
                    <option value="active">Aktif</option>
                    <option value="inactive">Tidak Aktif</option>
                </select>
            </div>
            <div class="form-group">
                <label for="promoImage">Gambar</label>
                <input type="file" id="promoImage" accept="image/*">
                <img id="promoImagePreview" class="image-preview" style="display:none;">
            </div>
            <button type="submit" class="btn-save">Simpan</button>
        </form>
    </div>
</div>

<!-- Create/Edit Promo Modal -->
<div id="createPromoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="createPromoModalTitle">Buat Promo Anggota</h3>
            <span class="close-btn" onclick="closeCreatePromoModal()">&times;</span>
        </div>
        <form id="createPromoForm">
            <input type="hidden" id="memberPromoId">
            <div class="form-group" id="promoTypeSelectorGroup">
                <label>Pilih Tipe Promo</label>
                <div class="promo-type-selector">
                    <div class="promo-type-option selected" data-type="selected">
                        <i class="fas fa-users"></i>
                        <h4>Pilih Anggota</h4>
                        <p>Kirim ke anggota tertentu</p>
                    </div>
                    <div class="promo-type-option" data-type="all">
                        <i class="fas fa-user-friends"></i>
                        <h4>Semua Anggota</h4>
                        <p>Kirim ke semua anggota</p>
                    </div>
                </div>
            </div>
            
            <div class="member-selection show" id="memberSelection">
                <div class="form-group">
                    <label>Pilih Anggota</label>
                    <div class="checkbox-group" id="membersCheckboxGroup">
                        <!-- Will be populated with members -->
                    </div>
                    <div class="selected-count" id="selectedCount">0 anggota dipilih</div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="createPromoTitle">Judul Promo</label>
                <input type="text" id="createPromoTitle" required>
            </div>
            <div class="form-group">
                <label for="createPromoDescription">Deskripsi</label>
                <textarea id="createPromoDescription" required></textarea>
            </div>
            <div class="form-group">
                <label for="createPromoExpiryDate">Tanggal Kadaluarsa</label>
                <input type="date" id="createPromoExpiryDate" required>
            </div>
            <div class="form-group">
                <label for="createPromoImage">Gambar</label>
                <input type="file" id="createPromoImage" accept="image/*">
                <img id="createPromoImagePreview" class="image-preview" style="display:none;">
            </div>
            <div class="form-group">
                <label for="createPromoMessage">Pesan Khusus (Opsional)</label>
                <textarea id="createPromoMessage" placeholder="Tambahkan pesan khusus untuk anggota..."></textarea>
            </div>
            <button type="submit" class="btn-save">Kirim Promo</button>
        </form>
    </div>
</div>

<!-- Public Promo Modal -->
<div id="publicPromoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Buat Promo Publik</h3>
            <span class="close-btn" onclick="closePublicPromoModal()">&times;</span>
        </div>
        <form id="publicPromoForm">
            <div class="form-group">
                <label for="publicPromoTitle">Judul Promo</label>
                <input type="text" id="publicPromoTitle" required>
            </div>
            <div class="form-group">
                <label for="publicPromoDescription">Deskripsi</label>
                <textarea id="publicPromoDescription" required></textarea>
            </div>
            <div class="form-group">
                <label for="publicPromoExpiryDate">Tanggal Kadaluarsa</label>
                <input type="date" id="publicPromoExpiryDate" required>
            </div>
            <div class="form-group">
                <label for="publicPromoImage">Gambar</label>
                <input type="file" id="publicPromoImage" accept="image/*">
                <img id="publicPromoImagePreview" class="image-preview" style="display:none;">
            </div>
            <button type="submit" class="btn-save">Publikasikan Promo</button>
        </form>
    </div>
</div>

<div id="notification" class="notification"></div>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script>
    // PERUBAHAN: Nonaktifkan fungsi pemeriksaan ukuran layar
    /*
    // Cek ukuran layar dan tampilkan notifikasi jika terlalu besar
    function checkScreenSize() {
        const width = window.innerWidth;
        const desktopNotification = document.getElementById('desktopNotification');
        
        if (width > 350) {
            desktopNotification.style.display = 'flex';
        } else {
            desktopNotification.style.display = 'none';
        }
    }
    
    // Fungsi untuk melanjutkan meskipun layar besar
    function continueAnyway() {
        document.getElementById('desktopNotification').style.display = 'none';
    }
    
    // Cek ukuran layar saat halaman dimuat
    window.addEventListener('load', checkScreenSize);
    
    // Cek ukuran layar saat jendela diubah ukurannya
    window.addEventListener('resize', checkScreenSize);
    */
    
    const firebaseConfig = { 
        apiKey: "AIzaSyCahZIFKFXMCokFNxCpFokNSVtKzN4llus", 
        authDomain: "cedar-setup-425414-d7.firebaseapp.com", 
        databaseURL: "https://cedar-setup-425414-d7-default-rtdb.firebaseio.com", 
        projectId: "cedar-setup-425414-d7", 
        storageBucket: "cedar-setup-425414-d7.firebasestorage.app", 
        messagingSenderId: "723545991983", 
        appId: "1:723545991983:web:379548d2b425a502a60fda", 
        measurementId: "G-FPL6PF3KWJ" 
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    
    // DOM Elements
    const eventTableBody = document.getElementById('eventTableBody');
    const promoTableBody = document.getElementById('promoTableBody');
    const memberPromoTableBody = document.getElementById('memberPromoTableBody');
    const totalEventsEl = document.getElementById('totalEvents');
    const totalPromosEl = document.getElementById('totalPromos');
    const activePromosEl = document.getElementById('activePromos');
    const sentPromosEl = document.getElementById('sentPromos');
    const notificationEl = document.getElementById('notification');
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const menuToggle = document.getElementById('menuToggle');
    
    // Modal Elements
    const eventModal = document.getElementById('eventModal');
    const eventForm = document.getElementById('eventForm');
    const promoModal = document.getElementById('promoModal');
    const promoForm = document.getElementById('promoForm');
    const createPromoModal = document.getElementById('createPromoModal');
    const createPromoForm = document.getElementById('createPromoForm');
    const publicPromoModal = document.getElementById('publicPromoModal');
    const publicPromoForm = document.getElementById('publicPromoForm');
    
    // Mobile menu toggle
    menuToggle.addEventListener('click', function() {
        sidebar.classList.toggle('active');
        mainContent.classList.toggle('expanded');
    });
    
    // Close sidebar when clicking outside on mobile
    document.addEventListener('click', function(e) {
        if (window.innerWidth <= 768) {
            if (!sidebar.contains(e.target) && !menuToggle.contains(e.target)) {
                sidebar.classList.remove('active');
                mainContent.classList.add('expanded');
            }
        }
    });
    
    // Notification Function
    function showNotification(message, type = 'success') {
        notificationEl.textContent = message;
        notificationEl.style.backgroundColor = type === 'success' ? 'var(--success-color)' : 'var(--danger-color)';
        notificationEl.classList.add('show');
        setTimeout(() => { notificationEl.classList.remove('show'); }, 3000);
    }
    
    // Tab Function
    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Update active state untuk sidebar dan bottombar
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
        });
        
        document.getElementById(`${tabName}-tab`).classList.add('active');
        
        document.querySelectorAll('.nav-link').forEach(link => {
            const linkTab = link.getAttribute('data-tab');
            if (linkTab === tabName) {
                link.classList.add('active');
            }
        });
        
        if (tabName === 'events') loadEvents();
        if (tabName === 'promos') loadPromos();
        if (tabName === 'memberPromos') loadMemberPromos();
    }
    
    // Event listener for tab navigation
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault(); // Mencegah scroll ke atas
            const tabName = this.getAttribute('data-tab');
            if (tabName) {
                showTab(tabName);
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('active');
                    mainContent.classList.add('expanded');
                }
            }
        });
    });
    
    // Convert image to base64
    function imageToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }
    
    // Event Functions
    function loadEvents() {
        eventTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Memuat data...</td></tr>';
        db.collection('events').get().then(snapshot => {
            eventTableBody.innerHTML = '';
            if (snapshot.empty) { 
                eventTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Belum ada data kopdar.</td></tr>'; 
                totalEventsEl.textContent = '0';
                return; 
            }
            totalEventsEl.textContent = snapshot.size;
            snapshot.forEach(doc => {
                const eventData = doc.data();
                const imageUrl = eventData.imageUrl || '';
                const imageHtml = imageUrl ? 
                    `<img src="${imageUrl}" alt="Event" style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px;">` : 
                    '<span style="color:#ccc; font-size: 0.8rem;">Tidak ada</span>';
                const date = eventData.startDate ? 
                    new Date(eventData.startDate.toDate()).toLocaleString('id-ID', { 
                        day: 'numeric', 
                        month: 'short', 
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : 
                    'Tidak ada tanggal';
                const statusBadge = eventData.status === 'active' ? 
                    '<span style="color: var(--success-color); font-size: 0.8rem;">Aktif</span>' : 
                    '<span style="color: var(--danger-color); font-size: 0.8rem;">Tidak Aktif</span>';
                
                const row = `
                    <tr>
                        <td>${imageHtml}</td>
                        <td>${eventData.name || 'Tidak ada nama'}</td>
                        <td>${date}</td>
                        <td>
                            <button class="btn-action btn-edit" onclick="openEventModal('${doc.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn-action btn-delete" onclick="deleteEvent('${doc.id}', '${eventData.name || 'Event'}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                eventTableBody.innerHTML += row;
            });
        }).catch(error => {
            console.error("Error loading events:", error);
            eventTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:red;">Gagal memuat data.</td></tr>';
        });
    }
    
    function openEventModal(eventId = null) {
        eventForm.reset();
        document.getElementById('eventImagePreview').style.display = 'none';
        
        if (eventId) {
            document.getElementById('eventModalTitle').textContent = 'Edit Kopdar';
            document.getElementById('eventId').value = eventId;
            
            db.collection('events').doc(eventId).get().then(doc => {
                if (doc.exists) {
                    const eventData = doc.data();
                    document.getElementById('eventName').value = eventData.name || '';
                    document.getElementById('eventDescription').value = eventData.description || '';
                    document.getElementById('eventStatus').value = eventData.status || 'active';
                    
                    if (eventData.startDate) {
                        const date = new Date(eventData.startDate.toDate());
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        const hours = String(date.getHours()).padStart(2, '0');
                        const minutes = String(date.getMinutes()).padStart(2, '0');
                        document.getElementById('eventDate').value = `${year}-${month}-${day}T${hours}:${minutes}`;
                    }
                    
                    if (eventData.imageUrl) {
                        document.getElementById('eventImagePreview').src = eventData.imageUrl;
                        document.getElementById('eventImagePreview').style.display = 'block';
                    }
                }
            }).catch(error => {
                console.error("Error getting event:", error);
                showNotification('Gagal memuat data kopdar.', 'error');
            });
        } else {
            document.getElementById('eventModalTitle').textContent = 'Tambah Kopdar';
            document.getElementById('eventId').value = '';
        }
        
        eventModal.classList.add('show');
    }
    
    function closeEventModal() {
        eventModal.classList.remove('show');
    }
    
    eventForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const eventId = document.getElementById('eventId').value;
        const name = document.getElementById('eventName').value;
        const description = document.getElementById('eventDescription').value;
        const date = document.getElementById('eventDate').value;
        const status = document.getElementById('eventStatus').value;
        const imageFile = document.getElementById('eventImage').files[0];
        
        const eventData = {
            name: name,
            description: description,
            status: status,
            startDate: new Date(date)
        };
        
        if (imageFile) {
            try {
                const base64Image = await imageToBase64(imageFile);
                eventData.imageUrl = base64Image;
            } catch (error) {
                console.error("Error converting image to base64:", error);
                showNotification('Gagal mengonversi gambar.', 'error');
                return;
            }
        }
        
        if (eventId) {
            db.collection('events').doc(eventId).update(eventData)
                .then(() => {
                    showNotification('Data kopdar berhasil diperbarui.');
                    closeEventModal();
                    loadEvents();
                })
                .catch(error => {
                    console.error("Error updating event:", error);
                    showNotification('Gagal memperbarui data kopdar.', 'error');
                });
        } else {
            db.collection('events').add(eventData)
                .then(() => {
                    showNotification('Kopdar berhasil ditambahkan.');
                    closeEventModal();
                    loadEvents();
                })
                .catch(error => {
                    console.error("Error adding event:", error);
                    showNotification('Gagal menambahkan kopdar.', 'error');
                });
        }
    });
    
    // Preview image when selected
    document.getElementById('eventImage').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('eventImagePreview').src = e.target.result;
                document.getElementById('eventImagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });
    
    function deleteEvent(eventId, eventName) {
        if (confirm(`Apakah Anda yakin ingin menghapus kopdar "${eventName}"?`)) {
            db.collection('events').doc(eventId).delete()
                .then(() => {
                    showNotification('Kopdar berhasil dihapus.');
                    loadEvents();
                })
                .catch(error => {
                    console.error("Error deleting event:", error);
                    showNotification('Gagal menghapus kopdar.', 'error');
                });
        }
    }
    
    // Promo Functions
    function loadPromos() {
        promoTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Memuat data...</td></tr>';
        db.collection('promos').get().then(snapshot => {
            promoTableBody.innerHTML = '';
            if (snapshot.empty) { 
                promoTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Belum ada data promo.</td></tr>'; 
                totalPromosEl.textContent = '0';
                activePromosEl.textContent = '0';
                return; 
            }
            let activeCount = 0;
            totalPromosEl.textContent = snapshot.size;
            snapshot.forEach(doc => {
                const promoData = doc.data();
                if (promoData.status === 'active') activeCount++;
                
                const imageUrl = promoData.imageUrl || '';
                const imageHtml = imageUrl ? 
                    `<img src="${imageUrl}" alt="Promo" style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px;">` : 
                    '<span style="color:#ccc; font-size: 0.8rem;">Tidak ada</span>';
                const expiryDate = promoData.expiryDate ? 
                    new Date(promoData.expiryDate.toDate()).toLocaleDateString('id-ID', { 
                        day: 'numeric', 
                        month: 'short', 
                        year: 'numeric'
                    }) : 
                    'Tidak ada tanggal';
                const statusBadge = promoData.status === 'active' ? 
                    '<span style="color: var(--success-color); font-size: 0.8rem;">Aktif</span>' : 
                    '<span style="color: var(--danger-color); font-size: 0.8rem;">Tidak Aktif</span>';
                
                const row = `
                    <tr>
                        <td>${imageHtml}</td>
                        <td>${promoData.title || 'Tidak ada judul'}</td>
                        <td>${expiryDate}</td>
                        <td>
                            <button class="btn-action btn-edit" onclick="openPromoModal('${doc.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn-action btn-delete" onclick="deletePromo('${doc.id}', '${promoData.title || 'Promo'}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                promoTableBody.innerHTML += row;
            });
            activePromosEl.textContent = activeCount;
        }).catch(error => {
            console.error("Error loading promos:", error);
            promoTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:red;">Gagal memuat data.</td></tr>';
        });
    }
    
    function openPromoModal(promoId = null) {
        promoForm.reset();
        document.getElementById('promoImagePreview').style.display = 'none';
        
        if (promoId) {
            document.getElementById('promoModalTitle').textContent = 'Edit Promo';
            document.getElementById('promoId').value = promoId;
            
            db.collection('promos').doc(promoId).get().then(doc => {
                if (doc.exists) {
                    const promoData = doc.data();
                    document.getElementById('promoTitle').value = promoData.title || '';
                    document.getElementById('promoDescription').value = promoData.description || '';
                    document.getElementById('promoStatus').value = promoData.status || 'active';
                    
                    if (promoData.expiryDate) {
                        const date = new Date(promoData.expiryDate.toDate());
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        document.getElementById('promoExpiryDate').value = `${year}-${month}-${day}`;
                    }
                    
                    if (promoData.imageUrl) {
                        document.getElementById('promoImagePreview').src = promoData.imageUrl;
                        document.getElementById('promoImagePreview').style.display = 'block';
                    }
                }
            }).catch(error => {
                console.error("Error getting promo:", error);
                showNotification('Gagal memuat data promo.', 'error');
            });
        } else {
            document.getElementById('promoModalTitle').textContent = 'Tambah Promo';
            document.getElementById('promoId').value = '';
        }
        
        promoModal.classList.add('show');
    }
    
    function closePromoModal() {
        promoModal.classList.remove('show');
    }
    
    promoForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const promoId = document.getElementById('promoId').value;
        const title = document.getElementById('promoTitle').value;
        const description = document.getElementById('promoDescription').value;
        const expiryDate = document.getElementById('promoExpiryDate').value;
        const status = document.getElementById('promoStatus').value;
        const imageFile = document.getElementById('promoImage').files[0];
        
        const promoData = {
            title: title,
            description: description,
            status: status,
            expiryDate: new Date(expiryDate)
        };
        
        if (imageFile) {
            try {
                const base64Image = await imageToBase64(imageFile);
                promoData.imageUrl = base64Image;
            } catch (error) {
                console.error("Error converting image to base64:", error);
                showNotification('Gagal mengonversi gambar.', 'error');
                return;
            }
        }
        
        if (promoId) {
            db.collection('promos').doc(promoId).update(promoData)
                .then(() => {
                    showNotification('Data promo berhasil diperbarui.');
                    closePromoModal();
                    loadPromos();
                })
                .catch(error => {
                    console.error("Error updating promo:", error);
                    showNotification('Gagal memperbarui data promo.', 'error');
                });
        } else {
            db.collection('promos').add(promoData)
                .then(() => {
                    showNotification('Promo berhasil ditambahkan.');
                    closePromoModal();
                    loadPromos();
                })
                .catch(error => {
                    console.error("Error adding promo:", error);
                    showNotification('Gagal menambahkan promo.', 'error');
                });
        }
    });
    
    // Preview image when selected
    document.getElementById('promoImage').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('promoImagePreview').src = e.target.result;
                document.getElementById('promoImagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });
    
    function deletePromo(promoId, promoName) {
        if (confirm(`Apakah Anda yakin ingin menghapus promo "${promoName}"?`)) {
            db.collection('promos').doc(promoId).delete()
                .then(() => {
                    showNotification('Promo berhasil dihapus.');
                    loadPromos();
                })
                .catch(error => {
                    console.error("Error deleting promo:", error);
                    showNotification('Gagal menghapus promo.', 'error');
                });
        }
    }
    
    // Member Promo Functions
    function loadMemberPromos() {
        memberPromoTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Memuat data...</td></tr>';
        // Kita akan mengurutkan di sisi klien untuk menangani data yang tidak memiliki 'createdAt'
        db.collection('memberPromos').get().then(snapshot => {
            memberPromoTableBody.innerHTML = '';
            if (snapshot.empty) { 
                memberPromoTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Belum ada promo anggota yang dibuat.</td></tr>'; 
                return; 
            }

            let promos = [];
            snapshot.forEach(doc => {
                let promoData = doc.data();
                promoData.id = doc.id; // Simpan ID untuk akses mudah
                // Jika tidak ada createdAt, beri nilai default agar tidak error saat diurutkan
                if (!promoData.createdAt) {
                    promoData.createdAt = firebase.firestore.Timestamp.fromDate(new Date(0)); // Timestamp paling awal
                }
                promos.push(promoData);
            });

            // Urutkan array berdasarkan createdAt (terbaru dulu)
            promos.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());

            // Tampilkan data yang sudah diurutkan
            promos.forEach(promoData => {
                const imageUrl = promoData.imageUrl || '';
                const imageHtml = imageUrl ? 
                    `<img src="${imageUrl}" alt="Promo" style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px;">` : 
                    '<span style="color:#ccc; font-size: 0.8rem;">Tidak ada</span>';
                const expiryDate = promoData.expiryDate ? 
                    new Date(promoData.expiryDate.toDate()).toLocaleDateString('id-ID', { 
                        day: 'numeric', 
                        month: 'short', 
                        year: 'numeric'
                    }) : 
                    'Tidak ada tanggal';
                const sentToText = promoData.sentTo === 'all' ? 'Semua' : 'Terpilih';
                
                const row = `
                    <tr>
                        <td>${imageHtml}</td>
                        <td>${promoData.title || 'Tidak ada judul'}</td>
                        <td>${sentToText}</td>
                        <td>
                            <button class="btn-action btn-edit" onclick="openEditMemberPromoModal('${promoData.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn-action btn-delete" onclick="deleteMemberPromo('${promoData.id}', '${promoData.title || 'Promo'}')"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
                memberPromoTableBody.innerHTML += row;
            });
        }).catch(error => {
            console.error("Error loading member promos:", error);
            memberPromoTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:red;">Gagal memuat data.</td></tr>';
        });
    }

    // Create/Edit Member Promo Modal Functions
    function openCreatePromoModal() {
        createPromoForm.reset();
        document.getElementById('memberPromoId').value = ''; // Ensure ID is cleared for new promo
        document.getElementById('createPromoImagePreview').style.display = 'none';
        document.getElementById('createPromoModalTitle').textContent = 'Buat Promo Anggota';
        document.getElementById('promoTypeSelectorGroup').style.display = 'block';
        document.getElementById('memberSelection').classList.add('show');
        
        // Load members for checkbox selection
        const checkboxGroup = document.getElementById('membersCheckboxGroup');
        checkboxGroup.innerHTML = '<p>Memuat data anggota...</p>';
        
        db.collection('users').get().then(snapshot => {
            checkboxGroup.innerHTML = '';
            if (snapshot.empty) {
                checkboxGroup.innerHTML = '<p>Tidak ada anggota yang tersedia.</p>';
                return;
            }
            
            snapshot.forEach(doc => {
                const userData = doc.data();
                const checkboxItem = document.createElement('div');
                checkboxItem.className = 'checkbox-item';
                checkboxItem.innerHTML = `
                    <input type="checkbox" id="member-${doc.id}" value="${doc.id}">
                    <label for="member-${doc.id}">${userData.username || 'Tanpa Nama'}</label>
                `;
                checkboxGroup.appendChild(checkboxItem);
            });
            
            const checkboxes = checkboxGroup.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectedCount);
            });
            
            updateSelectedCount();
        }).catch(error => {
            console.error("Error loading members for promo:", error);
            checkboxGroup.innerHTML = '<p>Gagal memuat data anggota.</p>';
        });
        
        // Setup promo type selector
        document.querySelectorAll('.promo-type-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.promo-type-option').forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                
                const type = this.getAttribute('data-type');
                if (type === 'all') {
                    document.getElementById('memberSelection').classList.remove('show');
                } else {
                    document.getElementById('memberSelection').classList.add('show');
                }
            });
        });
        
        createPromoModal.classList.add('show');
    }
    
    function openEditMemberPromoModal(promoId) {
        createPromoForm.reset();
        document.getElementById('memberPromoId').value = promoId;
        document.getElementById('createPromoImagePreview').style.display = 'none';
        document.getElementById('createPromoModalTitle').textContent = 'Edit Promo Anggota';
        
        // Hide promo type selector for editing
        document.getElementById('promoTypeSelectorGroup').style.display = 'none';
        document.getElementById('memberSelection').classList.remove('show');
        
        // Fetch and populate form data
        db.collection('memberPromos').doc(promoId).get().then(doc => {
            if (doc.exists) {
                const promoData = doc.data();
                document.getElementById('createPromoTitle').value = promoData.title || '';
                document.getElementById('createPromoDescription').value = promoData.description || '';
                document.getElementById('createPromoMessage').value = promoData.customMessage || '';
                
                if (promoData.expiryDate) {
                    const date = new Date(promoData.expiryDate.toDate());
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    document.getElementById('createPromoExpiryDate').value = `${year}-${month}-${day}`;
                }
                
                if (promoData.imageUrl) {
                    document.getElementById('createPromoImagePreview').src = promoData.imageUrl;
                    document.getElementById('createPromoImagePreview').style.display = 'block';
                }
            } else {
                showNotification('Promo tidak ditemukan.', 'error');
                closeCreatePromoModal();
            }
        }).catch(error => {
            console.error("Error getting member promo:", error);
            showNotification('Gagal memuat data promo.', 'error');
            closeCreatePromoModal();
        });
        
        createPromoModal.classList.add('show');
    }
    
    function closeCreatePromoModal() {
        createPromoModal.classList.remove('show');
        // Reset modal title and visibility for next use
        document.getElementById('createPromoModalTitle').textContent = 'Buat Promo Anggota';
        document.getElementById('promoTypeSelectorGroup').style.display = 'block';
    }
    
    function updateSelectedCount() {
        const checkboxes = document.querySelectorAll('#membersCheckboxGroup input[type="checkbox"]:checked');
        document.getElementById('selectedCount').textContent = `${checkboxes.length} anggota dipilih`;
    }
    
    createPromoForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const promoId = document.getElementById('memberPromoId').value;
        const isEdit = promoId !== null && promoId !== '';

        const title = document.getElementById('createPromoTitle').value;
        const description = document.getElementById('createPromoDescription').value;
        const expiryDate = document.getElementById('createPromoExpiryDate').value;
        const customMessage = document.getElementById('createPromoMessage').value;
        const imageFile = document.getElementById('createPromoImage').files[0];
        
        const promoData = {
            title: title,
            description: description,
            expiryDate: new Date(expiryDate),
            customMessage: customMessage,
            updatedAt: new Date()
        };
        
        if (imageFile) {
            try {
                const base64Image = await imageToBase64(imageFile);
                promoData.imageUrl = base64Image;
            } catch (error) {
                console.error("Error converting image to base64:", error);
                showNotification('Gagal mengonversi gambar.', 'error');
                return;
            }
        }

        if (isEdit) {
            // Update existing promo in memberPromos collection
            db.collection('memberPromos').doc(promoId).update(promoData)
                .then(() => {
                    showNotification('Promo anggota berhasil diperbarui.');
                    closeCreatePromoModal();
                    loadMemberPromos();
                })
                .catch(error => {
                    console.error("Error updating member promo:", error);
                    showNotification('Gagal memperbarui promo anggota.', 'error');
                });
        } else {
            // Create new promo and send to members
            promoData.createdAt = new Date();
            promoData.status = 'active';
            
            const selectedType = document.querySelector('.promo-type-option.selected').getAttribute('data-type');
            promoData.sentTo = selectedType === 'all' ? 'all' : 'selected';
            
            // Simpan ke koleksi memberPromos untuk ditampilkan di dashboard
            let memberPromoId;
            try {
                const docRef = await db.collection('memberPromos').add(promoData);
                memberPromoId = docRef.id;
            } catch (error) {
                console.error("Error saving member promo:", error);
                showNotification('Gagal menyimpan promo anggota.', 'error');
                return;
            }
            
            const deliveryPromoData = { ...promoData, memberPromoId: memberPromoId };
            
            if (selectedType === 'all') {
                // Send to all members
                db.collection('users').get().then(snapshot => {
                    const promises = [];
                    snapshot.forEach(doc => {
                        const userId = doc.id;
                        promises.push(sendPromoToUser(userId, deliveryPromoData));
                    });
                    
                    Promise.all(promises).then(() => {
                        showNotification(`Promo berhasil dikirim ke semua anggota.`);
                        closeCreatePromoModal();
                        loadMemberPromos();
                        const currentSent = parseInt(sentPromosEl.textContent) || 0;
                        sentPromosEl.textContent = currentSent + snapshot.size;
                    }).catch(error => {
                        console.error("Error sending promo to all members:", error);
                        showNotification('Gagal mengirim promo ke beberapa anggota.', 'error');
                    });
                });
            } else {
                // Send to selected members
                const checkboxes = document.querySelectorAll('#membersCheckboxGroup input[type="checkbox"]:checked');
                
                if (checkboxes.length === 0) {
                    showNotification('Pilih setidaknya satu anggota untuk mengirim promo.', 'error');
                    return;
                }
                
                const promises = [];
                checkboxes.forEach(checkbox => {
                    const userId = checkbox.value;
                    promises.push(sendPromoToUser(userId, deliveryPromoData));
                });
                
                Promise.all(promises).then(() => {
                    showNotification(`Promo berhasil dikirim ke ${checkboxes.length} anggota.`);
                    closeCreatePromoModal();
                    loadMemberPromos();
                    const currentSent = parseInt(sentPromosEl.textContent) || 0;
                    sentPromosEl.textContent = currentSent + checkboxes.length;
                }).catch(error => {
                    console.error("Error sending promo to members:", error);
                    showNotification('Gagal mengirim promo ke beberapa anggota.', 'error');
                });
            }
        }
    });

    function sendPromoToUser(userId, promoData) {
        const deliveryData = {
            ...promoData,
            userId: userId,
            sentAt: new Date(),
            status: 'sent',
            read: false
        };
        
        const specialPromoPromise = db.collection('users').doc(userId).collection('specialPromos').add(deliveryData);
        
        const notificationData = {
            type: 'promo',
            title: 'Promo Khusus Untuk Anda',
            message: `Anda menerima promo: ${promoData.title}`,
            data: { memberPromoId: promoData.memberPromoId },
            createdAt: new Date(),
            read: false
        };
        
        const notificationPromise = db.collection('users').doc(userId).collection('notifications').add(notificationData);
        
        return Promise.all([specialPromoPromise, notificationPromise]);
    }
    
    // Preview image when selected
    document.getElementById('createPromoImage').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('createPromoImagePreview').src = e.target.result;
                document.getElementById('createPromoImagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });
    
    function deleteMemberPromo(promoId, promoName) {
        if (confirm(`Apakah Anda yakin ingin menghapus promo anggota "${promoName}"? Ini akan menghapus template promo dari dashboard.`)) {
            db.collection('memberPromos').doc(promoId).delete()
                .then(() => {
                    showNotification('Promo anggota berhasil dihapus dari dashboard.');
                    loadMemberPromos();
                })
                .catch(error => {
                    console.error("Error deleting member promo:", error);
                    showNotification('Gagal menghapus promo anggota.', 'error');
                });
        }
    }
    
    // Public Promo Functions
    function openPublicPromoModal() {
        publicPromoForm.reset();
        document.getElementById('publicPromoImagePreview').style.display = 'none';
        publicPromoModal.classList.add('show');
    }
    
    function closePublicPromoModal() {
        publicPromoModal.classList.remove('show');
    }
    
    publicPromoForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const title = document.getElementById('publicPromoTitle').value;
        const description = document.getElementById('publicPromoDescription').value;
        const expiryDate = document.getElementById('publicPromoExpiryDate').value;
        const imageFile = document.getElementById('publicPromoImage').files[0];
        
        const promoData = {
            title: title,
            description: description,
            status: 'active',
            expiryDate: new Date(expiryDate),
            createdAt: new Date()
        };
        
        if (imageFile) {
            try {
                const base64Image = await imageToBase64(imageFile);
                promoData.imageUrl = base64Image;
            } catch (error) {
                console.error("Error converting image to base64:", error);
                showNotification('Gagal mengonversi gambar.', 'error');
                return;
            }
        }
        
        db.collection('publicPromos').add(promoData)
            .then(() => {
                showNotification('Promo publik berhasil dibuat dan dipublikasikan!');
                closePublicPromoModal();
                const currentSent = parseInt(sentPromosEl.textContent) || 0;
                sentPromosEl.textContent = currentSent + 1;
            })
            .catch(error => {
                console.error("Error adding public promo:", error);
                showNotification('Gagal membuat promo publik.', 'error');
            });
    });
    
    // Preview image when selected
    document.getElementById('publicPromoImage').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('publicPromoImagePreview').src = e.target.result;
                document.getElementById('publicPromoImagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Window Click Event
    window.onclick = function(event) { 
        if (event.target == eventModal) closeEventModal();
        else if (event.target == promoModal) closePromoModal();
        else if (event.target == createPromoModal) closeCreatePromoModal();
        else if (event.target == publicPromoModal) closePublicPromoModal();
    }
    
    // Initialize
    loadEvents();
    loadPromos();
    loadMemberPromos();
</script>
</body>
</html>
